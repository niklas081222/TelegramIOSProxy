name: Build TranslateGram iOS

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths-ignore:
      - 'proxy-server/**'
      - '**.md'

jobs:
  build:
    runs-on: macos-14
    timeout-minutes: 180

    env:
      TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
      TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
      BUNDLE_ID: com.niklas.translategram
      TEAM_ID: 5RPK5SFG6M

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Clone Telegram-iOS (release-11.13, Xcode 16.2)
        run: |
          echo "=== Cloning official Telegram-iOS at release-11.13 ==="
          git clone --branch release-11.13 --depth 1 https://github.com/TelegramMessenger/Telegram-iOS.git telegram-ios-build
          cd telegram-ios-build
          git submodule update --init --recursive --depth 1
          cd ..
          echo "=== Clone complete ==="

      - name: Apply modifications
        run: |
          echo "=== Copying AITranslation module ==="
          cp -r telegram-ios/AITranslation telegram-ios-build/submodules/AITranslation

          echo "=== Applying patches ==="
          bash scripts/apply-patches.sh telegram-ios-build

      - name: Setup Xcode 16.2
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.2'

      - name: Configure Xcode
        run: |
          sudo xcode-select --switch /Applications/Xcode_16.2.app/Contents/Developer
          sudo xcodebuild -runFirstLaunch 2>/dev/null || true
          sudo xcodebuild -license accept 2>/dev/null || true

          echo "Xcode path: $(xcode-select -p)"
          echo "Xcode version: $(xcodebuild -version | head -1)"
          xcodebuild -showsdks | grep -i "ios\|iphoneos"

      - name: Write build configuration
        run: |
          API_ID="${TELEGRAM_API_ID:-12345}"
          API_HASH="${TELEGRAM_API_HASH:-abcdef1234567890abcdef1234567890}"

          python3 -c "
          import json, pathlib
          cfg = {
              'bundle_id': '${BUNDLE_ID}',
              'api_id': '${API_ID}',
              'api_hash': '${API_HASH}',
              'team_id': '${TEAM_ID}',
              'app_center_id': '0',
              'is_internal_build': 'true',
              'is_appstore_build': 'false',
              'appstore_id': '0',
              'app_specific_url_scheme': 'tg',
              'premium_iap_product_id': '',
              'enable_siri': False,
              'enable_icloud': False
          }
          pathlib.Path('telegram-ios-build/build-system/appstore-configuration.json').write_text(json.dumps(cfg, indent=2))
          "

          echo "Build configuration written"
          cat telegram-ios-build/build-system/appstore-configuration.json

      - name: Install provisioning profiles
        run: |
          PROFILES_DIR="telegram-ios-build/build-system/fake-codesigning/profiles"
          mkdir -p "$PROFILES_DIR"

          echo "${{ secrets.PROFILE_TELEGRAM }}" | base64 -d > "$PROFILES_DIR/Telegram.mobileprovision"
          echo "${{ secrets.PROFILE_SHARE }}" | base64 -d > "$PROFILES_DIR/Share.mobileprovision"
          echo "${{ secrets.PROFILE_WIDGET }}" | base64 -d > "$PROFILES_DIR/Widget.mobileprovision"
          echo "${{ secrets.PROFILE_NOTIFICATIONCONTENT }}" | base64 -d > "$PROFILES_DIR/NotificationContent.mobileprovision"
          echo "${{ secrets.PROFILE_NOTIFICATIONSERVICE }}" | base64 -d > "$PROFILES_DIR/NotificationService.mobileprovision"
          echo "${{ secrets.PROFILE_INTENTS }}" | base64 -d > "$PROFILES_DIR/Intents.mobileprovision"
          echo "${{ secrets.PROFILE_BROADCASTUPLOAD }}" | base64 -d > "$PROFILES_DIR/BroadcastUpload.mobileprovision"
          echo "${{ secrets.PROFILE_WATCHAPP }}" | base64 -d > "$PROFILES_DIR/WatchApp.mobileprovision"
          echo "${{ secrets.PROFILE_WATCHEXTENSION }}" | base64 -d > "$PROFILES_DIR/WatchExtension.mobileprovision"

          echo "Installed $(ls "$PROFILES_DIR"/*.mobileprovision | wc -l) profiles"
          ls -la "$PROFILES_DIR"

      - name: Setup signing keychain
        run: |
          KEYCHAIN="build.keychain"
          KEYCHAIN_PASSWORD="build_password_ci"

          # Create and configure keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN"
          security set-keychain-settings "$KEYCHAIN"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN"

          # Decode and import the real signing certificate
          echo "${{ secrets.SIGNING_CERTIFICATE_P12 }}" | base64 -d > /tmp/signing.p12
          security import /tmp/signing.p12 -k "$KEYCHAIN" \
            -P "${{ secrets.SIGNING_CERTIFICATE_PASSWORD }}" \
            -T /usr/bin/codesign -T /usr/bin/security
          rm -f /tmp/signing.p12

          # Download and import Apple WWDR intermediate certificates
          curl -sL "https://www.apple.com/certificateauthority/AppleWWDRCAG3.cer" -o /tmp/AppleWWDRCAG3.cer
          security import /tmp/AppleWWDRCAG3.cer -k "$KEYCHAIN" -T /usr/bin/codesign
          rm -f /tmp/AppleWWDRCAG3.cer

          # Add to search list
          EXISTING=$(security list-keychains -d user | tr -d '"' | tr '\n' ' ')
          security list-keychains -d user -s "$KEYCHAIN" $EXISTING

          # Allow codesign to access without prompting
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN"

          # Verify
          echo "=== Signing identities ==="
          security find-identity -v -p codesigning "$KEYCHAIN"

      - name: Patch build system for CI
        run: |
          python3 scripts/patch_build_configuration.py telegram-ios-build

      - name: Setup Bazel remote cache
        run: |
          echo '${{ secrets.GCS_SA_KEY }}' > /tmp/gcs-key.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=/tmp/gcs-key.json" >> $GITHUB_ENV
          echo "GCS cache configured for translategram-bazel-cache bucket"

      - name: Build IPA
        working-directory: telegram-ios-build
        run: |
          echo "=== Build environment ==="
          xcode-select -p
          xcodebuild -version
          python3 --version
          echo ""

          echo "=== Starting build (with GCS remote cache) ==="
          python3 build-system/Make/Make.py \
            --cacheHost=https://storage.googleapis.com/translategram-bazel-cache \
            build \
            --configurationPath=build-system/appstore-configuration.json \
            --codesigningInformationPath=build-system/fake-codesigning \
            --buildNumber=${{ github.run_number }} \
            --configuration=debug_arm64

          echo "=== Build complete ==="

      - name: Find and collect artifacts
        if: always()
        run: |
          rm -f /tmp/gcs-key.json
          echo "=== Searching for build artifacts ==="
          mkdir -p artifacts

          # Bazel output is behind a symlink (bazel-bin), so copy directly
          cp telegram-ios-build/bazel-bin/Telegram/Telegram.ipa artifacts/ 2>/dev/null || true
          # Also search with symlink following as fallback
          find -L telegram-ios-build -name "*.ipa" -exec cp {} artifacts/ \; 2>/dev/null || true

          echo ""
          echo "Artifacts found:"
          ls -la artifacts/ 2>/dev/null || echo "No artifacts found"

      - name: Upload IPA artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: translategram-ios-${{ github.run_number }}
          path: artifacts/
          retention-days: 30
          if-no-files-found: warn
