name: Build TranslateGram iOS

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths-ignore:
      - 'proxy-server/**'
      - '**.md'

jobs:
  build:
    runs-on: macos-14
    timeout-minutes: 180

    env:
      TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
      TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
      BUNDLE_ID: ${{ secrets.BUNDLE_ID || 'com.aitranslate.messenger' }}
      TEAM_ID: ${{ secrets.TEAM_ID || 'PLACEHOLDER' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Clone Telegram-iOS
        run: |
          echo "=== Cloning official Telegram-iOS ==="
          git clone --depth 1 https://github.com/TelegramMessenger/Telegram-iOS.git telegram-ios-build
          cd telegram-ios-build
          git submodule update --init --recursive --depth 1
          cd ..
          echo "=== Clone complete ==="

      - name: Apply modifications
        run: |
          echo "=== Copying AITranslation module ==="
          cp -r telegram-ios/AITranslation telegram-ios-build/submodules/AITranslation

          echo "=== Applying patches ==="
          bash scripts/apply-patches.sh telegram-ios-build

      - name: Determine Xcode version
        id: xcode-version
        run: |
          if [ -f "telegram-ios-build/versions.json" ]; then
            XCODE_VERSION=$(python3 -c "import json; print(json.load(open('telegram-ios-build/versions.json'))['xcode'])" 2>/dev/null || echo "16.2")
          else
            XCODE_VERSION="16.2"
          fi
          echo "version=${XCODE_VERSION}" >> $GITHUB_OUTPUT
          echo "Xcode version: ${XCODE_VERSION}"

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ steps.xcode-version.outputs.version }}

      - name: Write build configuration
        run: |
          API_ID="${TELEGRAM_API_ID:-12345}"
          API_HASH="${TELEGRAM_API_HASH:-abcdef1234567890abcdef1234567890}"

          cat > telegram-ios-build/build-system/appstore-configuration.json << 'CONFIGEOF'
          {
            "bundle_id": "com.aitranslate.messenger",
            "api_id": "12345",
            "api_hash": "abcdef1234567890abcdef1234567890",
            "team_id": "PLACEHOLDER",
            "app_center_id": "0",
            "is_internal_build": "true",
            "is_appstore_build": "false",
            "appstore_id": "0",
            "app_specific_url_scheme": "tg",
            "premium_iap_product_id": "",
            "enable_siri": false,
            "enable_icloud": false
          }
          CONFIGEOF

          # Override with secrets if available
          if [ -n "$API_ID" ] && [ "$API_ID" != "12345" ]; then
            python3 -c "
          import json
          with open('telegram-ios-build/build-system/appstore-configuration.json') as f:
              config = json.load(f)
          config['api_id'] = '${API_ID}'
          config['api_hash'] = '${API_HASH}'
          config['bundle_id'] = '${BUNDLE_ID}'
          config['team_id'] = '${TEAM_ID}'
          with open('telegram-ios-build/build-system/appstore-configuration.json', 'w') as f:
              json.dump(config, f, indent=2)
          "
          fi

          echo "Build configuration written"
          cat telegram-ios-build/build-system/appstore-configuration.json

      - name: Setup Bazel cache
        uses: actions/cache@v4
        with:
          path: ~/bazel-disk-cache
          key: bazel-${{ runner.os }}-${{ hashFiles('telegram-ios-build/versions.json') }}
          restore-keys: |
            bazel-${{ runner.os }}-

      - name: Build IPA
        working-directory: telegram-ios-build
        run: |
          echo "=== Starting build ==="
          echo "Available Xcode versions:"
          ls /Applications/ | grep Xcode || true
          echo "Active Xcode:"
          xcode-select -p
          xcodebuild -version

          python3 build-system/Make/Make.py \
            --cacheDir="$HOME/bazel-disk-cache" \
            build \
            --configurationPath=build-system/appstore-configuration.json \
            --codesigningInformationPath=build-system/fake-codesigning \
            --buildNumber=${{ github.run_number }} \
            --configuration=debug_arm64 \
            --disableProvisioningProfiles \
            --disableExtensions

          echo "=== Build complete ==="

      - name: Find and collect artifacts
        if: always()
        run: |
          echo "=== Searching for build artifacts ==="
          mkdir -p artifacts

          # Look for IPA files anywhere in the build tree
          find telegram-ios-build -name "*.ipa" -exec cp {} artifacts/ \; 2>/dev/null || true

          # Look for app bundles
          find telegram-ios-build/build -name "*.app" -maxdepth 3 -exec cp -r {} artifacts/ \; 2>/dev/null || true

          echo "Artifacts found:"
          ls -la artifacts/ 2>/dev/null || echo "No artifacts found"

      - name: Upload IPA artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: translategram-ios-${{ github.run_number }}
          path: artifacts/
          retention-days: 30
          if-no-files-found: warn
