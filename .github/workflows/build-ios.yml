name: Build TranslateGram iOS

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths-ignore:
      - 'proxy-server/**'
      - '**.md'

jobs:
  build:
    runs-on: macos-15
    timeout-minutes: 180

    env:
      TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
      TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Clone Telegram-iOS (release-11.13, Xcode 16.2)
        run: |
          echo "=== Cloning official Telegram-iOS at release-11.13 ==="
          git clone --branch release-11.13 --depth 1 https://github.com/TelegramMessenger/Telegram-iOS.git telegram-ios-build
          cd telegram-ios-build
          git submodule update --init --recursive --depth 1
          cd ..
          echo "=== Clone complete ==="

      - name: Apply modifications
        run: |
          echo "=== Copying AITranslation module ==="
          cp -r telegram-ios/AITranslation telegram-ios-build/submodules/AITranslation

          echo "=== Applying patches ==="
          bash scripts/apply-patches.sh telegram-ios-build

      - name: Setup Xcode 16.2
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.2'

      - name: Write build configuration
        run: |
          API_ID="${TELEGRAM_API_ID:-12345}"
          API_HASH="${TELEGRAM_API_HASH:-abcdef1234567890abcdef1234567890}"

          # Use the same team_id and bundle_id as the fake-codesigning profiles
          python3 -c "
          import json, pathlib
          cfg = {
              'bundle_id': 'ph.telegra.Telegraph',
              'api_id': '${API_ID}',
              'api_hash': '${API_HASH}',
              'team_id': 'C67CF9S4VU',
              'app_center_id': '0',
              'is_internal_build': 'true',
              'is_appstore_build': 'false',
              'appstore_id': '0',
              'app_specific_url_scheme': 'tg',
              'premium_iap_product_id': '',
              'enable_siri': False,
              'enable_icloud': False
          }
          pathlib.Path('telegram-ios-build/build-system/appstore-configuration.json').write_text(json.dumps(cfg, indent=2))
          "

          echo "Build configuration written"
          cat telegram-ios-build/build-system/appstore-configuration.json

      - name: Patch profile copying to use macOS security cms
        working-directory: telegram-ios-build
        run: |
          # The copy_profiles_from_directory function in BuildConfiguration.py uses
          # openssl smime which may not work with macOS LibreSSL.
          # Patch it to fall back to 'security cms -D' (macOS native) if openssl fails.
          python3 << 'PYEOF'
          import re

          path = "build-system/Make/BuildConfiguration.py"
          with open(path, "r") as f:
              content = f.read()

          # Find and replace the openssl smime call with a version that falls back to security cms
          old_pattern = "profile_data = subprocess.check_output(['openssl', 'smime', '-inform', 'der', '-verify', '-noverify', '-in', file_path])"

          new_code = """try:
                    profile_data = subprocess.check_output(['openssl', 'smime', '-inform', 'der', '-verify', '-noverify', '-in', file_path], stderr=subprocess.DEVNULL)
                except subprocess.CalledProcessError:
                    # Fallback: use macOS security cms tool
                    profile_data = subprocess.check_output(['security', 'cms', '-D', '-i', file_path])"""

          if old_pattern in content:
              content = content.replace(old_pattern, new_code)
              print("Patched openssl smime -> security cms fallback")
          else:
              # Try a more flexible approach - find any line with openssl smime
              lines = content.split('\n')
              new_lines = []
              patched = False
              for line in lines:
                  if 'openssl' in line and 'smime' in line and 'profile_data' in line:
                      indent = len(line) - len(line.lstrip())
                      spaces = ' ' * indent
                      new_lines.append(f"{spaces}try:")
                      new_lines.append(f"{spaces}    profile_data = subprocess.check_output(['openssl', 'smime', '-inform', 'der', '-verify', '-noverify', '-in', file_path], stderr=subprocess.DEVNULL)")
                      new_lines.append(f"{spaces}except subprocess.CalledProcessError:")
                      new_lines.append(f"{spaces}    profile_data = subprocess.check_output(['security', 'cms', '-D', '-i', file_path])")
                      patched = True
                  else:
                      new_lines.append(line)
              if patched:
                  content = '\n'.join(new_lines)
                  print("Patched openssl smime (flexible match) -> security cms fallback")
              else:
                  print("WARNING: Could not find openssl smime call to patch")

          with open(path, "w") as f:
              f.write(content)

          # Debug: print the patched function
          print("\n--- Patched copy_profiles_from_directory ---")
          in_func = False
          for line in content.split('\n'):
              if 'def copy_profiles_from_directory' in line:
                  in_func = True
              if in_func:
                  print(line)
                  if line.strip().startswith('def ') and 'copy_profiles_from_directory' not in line:
                      break
          PYEOF

          # Also debug: test openssl and security cms on a profile
          echo "=== Testing profile parsing tools ==="
          echo "openssl version:"
          openssl version || true
          echo ""
          echo "Testing openssl smime on Telegram.mobileprovision:"
          openssl smime -inform der -verify -noverify -in build-system/fake-codesigning/profiles/Telegram.mobileprovision > /dev/null 2>&1 && echo "  SUCCESS" || echo "  FAILED"
          echo "Testing security cms on Telegram.mobileprovision:"
          security cms -D -i build-system/fake-codesigning/profiles/Telegram.mobileprovision > /dev/null 2>&1 && echo "  SUCCESS" || echo "  FAILED"

      - name: Build IPA
        working-directory: telegram-ios-build
        run: |
          echo "=== Build environment ==="
          xcode-select -p
          xcodebuild -version
          python3 --version
          echo ""

          echo "=== Starting build ==="
          python3 build-system/Make/Make.py \
            build \
            --configurationPath=build-system/appstore-configuration.json \
            --codesigningInformationPath=build-system/fake-codesigning \
            --buildNumber=${{ github.run_number }} \
            --configuration=debug_arm64

          echo "=== Build complete ==="

      - name: Find and collect artifacts
        if: always()
        run: |
          echo "=== Searching for build artifacts ==="
          mkdir -p artifacts

          find telegram-ios-build -name "*.ipa" -exec cp {} artifacts/ \; 2>/dev/null || true
          find telegram-ios-build/build -name "*.app" -maxdepth 3 -exec cp -r {} artifacts/ \; 2>/dev/null || true

          # Debug: show what's in the configuration repository
          echo "=== Configuration repository contents ==="
          find telegram-ios-build/build-input/configuration-repository -type f 2>/dev/null || echo "No configuration repository found"

          echo ""
          echo "Artifacts found:"
          ls -la artifacts/ 2>/dev/null || echo "No artifacts found"

      - name: Upload IPA artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: translategram-ios-${{ github.run_number }}
          path: artifacts/
          retention-days: 30
          if-no-files-found: warn
