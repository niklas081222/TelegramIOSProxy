name: Build TranslateGram iOS

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths-ignore:
      - 'proxy-server/**'
      - '**.md'

jobs:
  build:
    runs-on: macos-15
    timeout-minutes: 180

    env:
      TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
      TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
      DEVELOPER_DIR: /Applications/Xcode_16.2.app/Contents/Developer

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Clone Telegram-iOS (release-11.13, Xcode 16.2)
        run: |
          echo "=== Cloning official Telegram-iOS at release-11.13 ==="
          git clone --branch release-11.13 --depth 1 https://github.com/TelegramMessenger/Telegram-iOS.git telegram-ios-build
          cd telegram-ios-build
          git submodule update --init --recursive --depth 1
          cd ..
          echo "=== Clone complete ==="

      - name: Apply modifications
        run: |
          echo "=== Copying AITranslation module ==="
          cp -r telegram-ios/AITranslation telegram-ios-build/submodules/AITranslation

          echo "=== Applying patches ==="
          bash scripts/apply-patches.sh telegram-ios-build

      - name: Setup Xcode 16.2
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.2'

      - name: Configure Xcode and iOS platform
        run: |
          XCODE_DEV="/Applications/Xcode_16.2.app/Contents/Developer"

          # Ensure Xcode is fully configured
          sudo xcode-select --switch "$XCODE_DEV"
          sudo xcodebuild -runFirstLaunch 2>/dev/null || true
          sudo xcodebuild -license accept 2>/dev/null || true

          echo "Xcode path: $(xcode-select -p)"
          echo "Xcode version: $(xcodebuild -version | head -1)"

          # Diagnose platform locations
          echo ""
          echo "=== Platform locations ==="
          echo "Xcode bundle platforms:"
          ls -la "$XCODE_DEV/Platforms/" 2>/dev/null || echo "  (none)"
          echo ""
          echo "System-level platforms:"
          ls -la /Library/Developer/Platforms/ 2>/dev/null || echo "  (none)"
          echo ""

          # On macOS 15+, iOS platform may be downloaded separately and stored
          # outside the Xcode bundle. ibtool (via Bazel's xctoolrunner) looks
          # inside the Xcode bundle, so we need to ensure it's there.
          XCODE_PLAT="$XCODE_DEV/Platforms/iPhoneOS.platform"
          SYS_PLAT="/Library/Developer/Platforms/iPhoneOS.platform"

          if [ ! -d "$XCODE_PLAT" ] && [ -d "$SYS_PLAT" ]; then
            echo "iOS platform found at system level but not in Xcode bundle, symlinking..."
            sudo ln -s "$SYS_PLAT" "$XCODE_PLAT"
          fi

          # Always try to download/register the iOS platform on macOS 15+
          # This ensures the platform is fully registered even if showsdks reports it
          echo ""
          echo "=== Ensuring iOS platform is registered ==="
          xcodebuild -downloadPlatform iOS 2>&1 || true

          echo ""
          echo "=== Available iOS SDKs ==="
          xcodebuild -showsdks | grep -i "ios\|iphoneos"

          # Verify ibtool can be found
          echo ""
          echo "ibtool path: $(xcrun --find ibtool 2>/dev/null || echo 'NOT FOUND')"

          # Final platform check
          echo ""
          echo "=== Final platform layout ==="
          ls -la "$XCODE_DEV/Platforms/" 2>/dev/null | grep -i iphone || echo "WARNING: iPhoneOS.platform not in Xcode bundle!"

      - name: Write build configuration
        run: |
          API_ID="${TELEGRAM_API_ID:-12345}"
          API_HASH="${TELEGRAM_API_HASH:-abcdef1234567890abcdef1234567890}"

          python3 -c "
          import json, pathlib
          cfg = {
              'bundle_id': 'ph.telegra.Telegraph',
              'api_id': '${API_ID}',
              'api_hash': '${API_HASH}',
              'team_id': 'C67CF9S4VU',
              'app_center_id': '0',
              'is_internal_build': 'true',
              'is_appstore_build': 'false',
              'appstore_id': '0',
              'app_specific_url_scheme': 'tg',
              'premium_iap_product_id': '',
              'enable_siri': False,
              'enable_icloud': False
          }
          pathlib.Path('telegram-ios-build/build-system/appstore-configuration.json').write_text(json.dumps(cfg, indent=2))
          "

          echo "Build configuration written"
          cat telegram-ios-build/build-system/appstore-configuration.json

      - name: Fix expired provisioning profiles
        run: |
          python3 scripts/fix_profile_expiration.py telegram-ios-build

      - name: Patch profile copying to directly copy fake profiles
        run: |
          python3 scripts/patch_build_configuration.py telegram-ios-build

      - name: Verify ibtool can compile XIBs
        run: |
          echo "=== Testing ibtool directly ==="
          mkdir -p /tmp/ibtool-test

          # Test 1: ibtool with full environment (should work)
          echo "Test 1: ibtool with full environment"
          xcrun ibtool --compile /tmp/ibtool-test/LaunchScreen.nib \
            --minimum-deployment-target 13.0 \
            --target-device iphone --target-device ipad \
            --module Telegram \
            telegram-ios-build/Telegram/Telegram-iOS/Base.lproj/LaunchScreen.xib \
            && echo "PASS: ibtool works with full env" \
            || echo "FAIL: ibtool fails even with full env"

          # Test 2: ibtool with stripped environment (mimics Bazel)
          echo ""
          echo "Test 2: ibtool with stripped environment (like Bazel)"
          env -i \
            DEVELOPER_DIR="$(xcode-select -p)" \
            HOME="$HOME" \
            TMPDIR="${TMPDIR:-/tmp}" \
            PATH=/usr/bin:/bin:/usr/sbin:/sbin \
            APPLE_SDK_PLATFORM=iPhoneOS \
            APPLE_SDK_VERSION_OVERRIDE=18.2 \
            XCODE_VERSION_OVERRIDE=16.2.0.16C5032a \
            xcrun ibtool --compile /tmp/ibtool-test/LaunchScreen2.nib \
            --minimum-deployment-target 13.0 \
            --target-device iphone --target-device ipad \
            --module Telegram \
            telegram-ios-build/Telegram/Telegram-iOS/Base.lproj/LaunchScreen.xib \
            && echo "PASS: ibtool works with stripped env + HOME" \
            || echo "FAIL: ibtool fails with stripped env + HOME"

          # Test 3: ibtool with only DEVELOPER_DIR (no HOME)
          echo ""
          echo "Test 3: ibtool with stripped env, no HOME"
          env -i \
            DEVELOPER_DIR="$(xcode-select -p)" \
            PATH=/usr/bin:/bin:/usr/sbin:/sbin \
            APPLE_SDK_PLATFORM=iPhoneOS \
            APPLE_SDK_VERSION_OVERRIDE=18.2 \
            XCODE_VERSION_OVERRIDE=16.2.0.16C5032a \
            xcrun ibtool --compile /tmp/ibtool-test/LaunchScreen3.nib \
            --minimum-deployment-target 13.0 \
            --target-device iphone --target-device ipad \
            --module Telegram \
            telegram-ios-build/Telegram/Telegram-iOS/Base.lproj/LaunchScreen.xib \
            && echo "PASS: ibtool works without HOME" \
            || echo "FAIL: ibtool fails without HOME"

          rm -rf /tmp/ibtool-test

      - name: Build IPA
        working-directory: telegram-ios-build
        run: |
          echo "=== Build environment ==="
          xcode-select -p
          xcodebuild -version
          python3 --version
          echo ""

          echo "=== Starting build ==="
          python3 build-system/Make/Make.py \
            build \
            --configurationPath=build-system/appstore-configuration.json \
            --codesigningInformationPath=build-system/fake-codesigning \
            --buildNumber=${{ github.run_number }} \
            --configuration=debug_arm64

          echo "=== Build complete ==="

      - name: Find and collect artifacts
        if: always()
        run: |
          echo "=== Searching for build artifacts ==="
          mkdir -p artifacts

          find telegram-ios-build -name "*.ipa" -exec cp {} artifacts/ \; 2>/dev/null || true
          find telegram-ios-build/build -name "*.app" -maxdepth 3 -exec cp -r {} artifacts/ \; 2>/dev/null || true

          echo "=== Configuration repository contents ==="
          find telegram-ios-build/build-input/configuration-repository -type f 2>/dev/null || echo "No configuration repository found"

          echo ""
          echo "Artifacts found:"
          ls -la artifacts/ 2>/dev/null || echo "No artifacts found"

      - name: Upload IPA artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: translategram-ios-${{ github.run_number }}
          path: artifacts/
          retention-days: 30
          if-no-files-found: warn
